#!/bin/bash

set -e
shopt -s extglob

LIBTAPI_VER=(-b 1100.0.11)
CCTOOLS_VER=(-b 973.0.1-ld64-609)
LDID_VER=v2.1.4

info() { echo "[info] $1"; }

ROOT="${PWD}"
STAGING="${ROOT}/staging"
PACKAGES="${ROOT}/packages"
export INSTALLPREFIX="${STAGING}/linux/iphone"

info "Creating prefix dir"
rm -rf "${STAGING}"
mkdir -p "${INSTALLPREFIX}"

info "Building libtapi"
cd "${STAGING}"
git clone https://github.com/tpoechtrager/apple-libtapi.git
git checkout "${LIBTAPI_VER[@]}"
cd apple-libtapi
mkdir output
./build.sh
./install.sh

info "Building cctools"
cd "${STAGING}"
git clone https://github.com/tpoechtrager/cctools-port.git
git checkout "${CCTOOLS_VER[@]}"
cd cctools-port/cctools
mkdir output
./configure \
	--prefix "${INSTALLPREFIX}" \
	--with-libtapi="${INSTALLPREFIX}" \
	--target="aarch64-apple-darwin14" \
	LDFLAGS="-Wl,-rpath,'\$\$ORIGIN/../lib' -Wl,-z,origin"
make
make install

info "Modifying toolchain"
cd "${INSTALLPREFIX}/bin"
for file in *; do
	mv "${file}" "${file#aarch64-apple-darwin14-}"
done

info "Installing ldid"
# TODO: Maybe build ldid ourselves?
curl -#L "https://github.com/sbingner/ldid/releases/download/${LDID_TAG}/linux-ldid.tgz" | tar -xzf - -C "${INSTALLPREFIX}/bin"

info "Packaging toolchain"
mkdir -p "${PACKAGES}"
cd "${STAGING}"
tar -czf "${PACKAGES}/darwin-tools.tar.gz" linux

info "Done!"
